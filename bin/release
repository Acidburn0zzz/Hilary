#!/usr/bin/env node

var path = require('path');
var util = require('util');

var BinUtil = require('./lib/util');
var PackageUtil = require('./lib/package/util');
var ReleaseUtil = require('./lib/release/util');

//////////////////////
// HANDLE ARGUMENTS //
//////////////////////

var argv = require('optimist')
    .usage('Usage: $0 [-s] [-p] -v <release version>')

    .alias('h', 'help')
    .describe('h', 'Show this help information.')

    .alias('s', 'skip-tests')
    .describe('s', 'Skip the unit tests in the release process.')

    .alias('p', 'package')
    .describe('p', 'Generate a package tarball (tar.gz) of the tag before erasing npm-shrinkwrap from master')

    .alias('v', 'version')
    .describe('v', 'Which version to release (e.g., 0.4.1)')
    .demand('v')

    .argv;

var version = argv.v;
var packageJsonPath = path.resolve('package.json');
var packageDest = 'dist';

// Display the help if requested
if (argv.h) {
    require('optimist').showHelp();
    return process.exit(0);
}

// Ensure everything is OK to do a release
ReleaseUtil.validateRelease(3);

// If they specified to package after the tag, verify everything is OK to package before doing anything
if (argv.p) {
    PackageUtil.validatePackage(packageDest, 3);
}

// Load and validate the package.json
var packageJson = BinUtil.loadPackageJson(packageJsonPath, 4);

// Ensure our target version is a valid jump from where we are
ReleaseUtil.validateTargetVersion(packageJson, argv.v, 5);

// Optionally, run the tests right now
if (!argv.s) {
    BinUtil.runUnitTests(6);
} else {
    BinUtil.logWarn('Skipping unit tests because of -s parameter');
}

// Bump the version in package.json to the target version
ReleaseUtil.bumpPackageJsonVersion(packageJsonPath, packageJson.version, argv.v, 7);

// Shrinkwrap our dependencies
ReleaseUtil.shrinkwrap(8);

// Commit the shrinkwrap and tag the release
ReleaseUtil.gitCommitShrinkwrapAndTag(argv.v, 9);

// Optionally package up the release on the tag
if (argv.p) {
    // Skip the tests and just use the version from package.json
    BinUtil.exec('bin/package -s', 'Error packaging up the distribution release', 10, true);
}

// Remove the shrinkwrap and commit it for master
ReleaseUtil.gitRemoveShrinkwrapAndCommit(argv.v, 11);

BinUtil.logSuccess('Successfully released Hilary '.text + argv.v.white + ' in your local repository'.text);
BinUtil.logInfo(' ');
BinUtil.logInfo('Next you will have to do the following:');
BinUtil.logInfo(' ');
BinUtil.logInfo('    1. Analyze the commits in your local repository and verify they are what you want. Look at the diffs between the 2 commits');
BinUtil.logInfo('       to ensure they are only bumping the versions and adding / removing npm-shrinkwrap.json.');
BinUtil.logInfo('            * Use "git log" and "git diff" to analyze the commits and their contents');
BinUtil.logInfo('            * Use "git tag" to verify that the tag '.text + argv.v.white + ' was indeed created'.text);
BinUtil.logInfo(' ');
BinUtil.logInfo('    2. If everything is OK, push the commits to the https://github.com/oaeproject/Hilary repository with "git push".');
BinUtil.logInfo(' ');
BinUtil.logInfo('    3. Once pushed, also push the tag you created with: "git push <remote> ' + argv.v + '"');
BinUtil.logInfo(' ');
BinUtil.logSuccess('Complete!');
