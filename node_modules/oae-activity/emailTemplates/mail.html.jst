<!-- Based on the responsive ZURG templates -->
<style>
    body {
        color: <%= skinVariables['text-color'] %>;
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: none;
        font-family: HelveticaNeue-Light, "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
        font-size:13px;
        height: 100%;
        padding: 0 25px;
        background-color: <%= skinVariables['body-background-color'] %>;
    }

    a {
        color: <%= skinVariables['link-color'] %>;
        text-decoration: none;
    }
    a:hover {
        color: <%= skinVariables['link-hover-color'] %>;
    }

    h1, h2, h3, h4, h5, h6 {
        color: #000;
        font-family: HelveticaNeue-Light, "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
        line-height: 1.1;
    }

    h1 {
        font-weight: 200;
    }

    h2 {
        font-weight: 200;
    }

    h3 {
        font-weight: 500;
    }

    .preview-tile-title-description {
        color: <%= skinVariables['tile-title-color'] %>;
    }
    .preview-tile-metadata-description {
        color: <%= skinVariables['tile-description-color'] %>;
    }

    .muted {
        color: <%= skinVariables['secondary-text-color'] %>;
    }

    .comment-level-1 {
        margin-left: 40px;
    }

    .comment-level-2 {
        margin-left: 80px;
    }
</style>

<%
    /**
     * Render the email header
     */
    var renderHeader = function(skinVariables) {
        var institutionalLogoURL = getThumbnailUrl(skinVariables['institutional-logo-url'].replace(/\'/g, ''));

        var str = '';
        str += '<td align="center">';
        str +=     '<img src="' + institutionalLogoURL + '" height="50" style="margin: 25px 0 40px;"/>';
        str += '</td>';
        print(str);
    };
%>

<%
    /**
     * Render the summary header of the email depending on the amount of activities coming in
     */
    var renderSummaryHeader = function(user) {
        var str = '';
        str += '<td align="center">';
        if (user.emailPreference === 'daily') {
            str +=     '<div style="margin-top: 2px;" class="muted">Here\'s your summary of todays activity</div>';
        } else if (user.emailPreference === 'weekly') {
            str +=     '<div style="margin-top: 2px;" class="muted">Here\'s your summary of last week\'s activity</div>';
        } else {
            // No summary header for immediate activity emails
            return;
        }
        str += '</td>';
        print(str);
    };
%>

<%
    /**
     * Render the email footer
     */
    var renderFooter = function() {
        var copyrightSymbolI18n = util.i18n.translate('COPYRIGHT_SYMBOL');
        var apereoFoundationI18n = util.i18n.translate('APEREO_FOUNDATION');
        var allRightsReservedI18n = util.i18n.translate('ALL_RIGHTS_RESERVED');
        var str = '';
        str += '<td align="center">';
        str +=     '<div style="font-size: 10px;margin: 40px 0 25px;width: 500px;">';
        str +=         '<div style="margin-bottom: 20px">You are receiving this email because your account settings indicate you would like to receive ' + tenant.displayName + ' related emails. If you wish to change the frequency of these emails or unsubscribe go to <a href="' + baseUrl + '" title="Your account settings">your account settings</a>.</div>';
        str +=         '<div>' + copyrightSymbolI18n + ' ' + apereoFoundationI18n + ' ' + new Date().getFullYear() + '. ' + allRightsReservedI18n + '</div>';
        str +=     '</div>';
        str += '</td>';
        print(str);
    };
%>

<%
    /**
     * [getThumbnailUrl description]
     *
     * @param  {[type]} thumbnailUrl [description]
     *
     * @return {[type]}              [description]
     */
    var getThumbnailUrl = function(thumbnailUrl) {
        if (thumbnailUrl.startsWith('https') ||
            thumbnailUrl.startsWith('http')) {
            return thumbnailUrl;
        } else {
            return baseUrl + thumbnailUrl;
        }
    }
%>

<%
    /**
     * Render the user thumbnail picture
     *
     * @param  {Object}    entity    The userprofile information
     */
    var renderUserThumbnail = function(entity) {
        var thumbnailUrl = baseUrl + '/ui/img/icons/user.png';
        if (entity && entity.thumbnailUrl) {
            thumbnailUrl = getThumbnailUrl(entity.thumbnailUrl);
        } else if (entity && entity['oae:thumbnail']) {
            thumbnailUrl = getThumbnailUrl(entity['oae:thumbnail'].url);
        }

        var profilePath = baseUrl;
        if (entity && entity.profilePath) {
            profilePath += entity.profilePath;
        } else if (entity && entity['oae:profilePath']) {
            profilePath = baseUrl + entity['oae:profilePath'];
        }

        var str = '';
        str += '<a class="thumbnail thumbnail-user" href="' + profilePath +  '" title="' + entity.displayName + '">';
        str += '    <img src="' + thumbnailUrl + '" alt="' + entity.displayName + '" style="height: 40px;width: 40px;" />';
        str += '</a>';
        print(str);
    };
%>

<%
    /**
     * Render the preview thumbnail picture
     *
     * @param  {Object}    entity    The preview profile information
     */
    var renderPreviewThumbnail = function(entity) {
        var thumbnailUrl = '';
        if (entity.thumbnailUrl) {
            thumbnailUrl = baseUrl + entity.thumbnailUrl;
        } else {
            var resourceType = entity.resourceType;
            if (resourceType === 'content') {
                resourceType = entity.resourceSubType;
            }
            thumbnailUrl = baseUrl + '/ui/img/icons/' + resourceType + '.png';
        }

        var fillClass = '';
        if (entity.thumbnailUrl) {
            fillClass = 'thumbnail-fill';
        }

        var str = '';
        str += '<tr>'
        str +=     '<td height="162" width="162" background="' + thumbnailUrl+ '" style="background-position: center;background-size: cover;border-color: #eeedeb;" valign="bottom">'
        str +=         '<div style="background-color: rgba(0,0,0,.8);padding: 7px">'
        str +=             '<h3 style="font-size: 14px;font-weight: 600;line-height: 1.4;margin: 0">'
        str +=                 '<a href="' + baseUrl + entity.profilePath + '" title="' + entity.displayName + '" style="text-decoration: none" target="_blank" class="preview-tile-title-description">' + entity.displayName + '</a>'
        str +=             '</h3>'
        str +=             '<small class="preview-tile-metadata-description">' + entity.displayName + '</small>'
        str +=         '</div>'
        str +=     '</td>'
        str += '</tr>'
        print(str);
    };
%>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http: //www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http: //www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width"/>
    </head>
    <body>
        <table style="margin: 0 auto;">
            <tbody>
                <tr id="email-header">
                    <% renderHeader(skinVariables) %>
                </tr>
                <tr>
                    <td style="font-size: 20px;font-weight: bold;" align="center">
                        <div>Hi <%= user.displayName %></div>
                    </td>
                </tr>
                <tr id="email-summary-header">
                    <% renderSummaryHeader(user) %>
                </tr>
                <% _.each(activities, function(activity) { %>
                    <tr style="font-size: 12px;">
                        <td>
                            <div style="background-color: #FFF;border: 2px solid #ededec;margin: 10px auto;padding: 30px;max-width: 700px;min-width:400px;">
                                <table style="clear: both;">
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div style="float: left;">
                                                    <% renderUserThumbnail(activity.primaryThumbnail); %>
                                                </div>
                                                <div style="padding-left: 52px;word-wrap: break-word;">
                                                    <div><% print(util.i18n.translate(activity.summary.i18nKey, activity.summary.i18nArguments)) %></div>
                                                    <div style="font-size: 11px;margin-top: 5px;" class="muted"><%= (new Date(activity.created)).toDateString() %></div>
                                                </div>
                                                <table style="margin-top: 25px;">
                                                    <tbody>
                                                        <%
                                                            _.each(activity.thumbnails, function(thumbnail) {
                                                                renderPreviewThumbnail(thumbnail)
                                                            });
                                                        %>
                                                    </tbody>
                                                </table>
                                                <% _.each(activity.comments, function(comment) {
                                                    %>
                                                    <div style="margin-top: 25px;min-height: 40px;" class="comment-level-<%= comment['oae:level'] %>">
                                                        <div style="float: left;">
                                                            <% renderUserThumbnail(comment.author); %>
                                                        </div>
                                                        <div style="padding-left: 52px;word-wrap: break-word;">
                                                            <div>
                                                                <a href="<%= baseUrl + comment.author['oae:profilePath'] %>" title="<%= comment.author.displayName %>"><%= comment.author.displayName %></a> <span class="muted"><%= (new Date(activity.created)).toDateString() %></span>
                                                                <div style="margin-top: 7px;"><%= comment.content.replace(/\n/g, '<br/>') %></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                <% }); %>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                <% }); %>
                <tr id="email-footer">
                    <% renderFooter() %>
                </tr>
            </tbody>
        </table>
    </body>
</html>
