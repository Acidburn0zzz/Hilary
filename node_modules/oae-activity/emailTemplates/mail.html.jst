<style>

    /***********************
     * CORE CSS OVERRIDES **
     **********************/

    body {
        background-color: <%= skinVariables['body-background-color'] %>;
        color: <%= skinVariables['text-color'] %>;
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: none;
        font-size: 13px;
        height: 100%;
        padding: 25px;
    }

    body > table {
        margin: 0 auto;
    }

    * {
        font-family: HelveticaNeue-Light, "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
    }

    a {
        color: <%= skinVariables['link-color'] %>;
        text-decoration: none;
    }

    a:hover {
        color: <%= skinVariables['link-hover-color'] %>;
    }

    h1, h2, h3, h4, h5, h6 {
        color: <%= skinVariables['text-color']%>;
        line-height: 1.1;
    }

    h1 {
        font-weight: 200;
    }

    h2 {
        font-weight: 200;
    }

    h3 {
        font-weight: 500;
    }

    .muted {
        color: <%= skinVariables['secondary-text-color'] %>;
    }


    /***********
     ** TILES **
     ***********/

    .preview-thumbnail-container {
        background-position: center;
        background-size: cover;
        border-color: #eeedeb;
        border-style: solid;
        border-width: 1px;
    }

    .preview-thumbnail-container .preview-thumbnail {
        background-color: rgba(0,0,0,.8);
        padding: 7px
    }

    .preview-thumbnail-container .preview-thumbnail h3 {
        font-size: 14px;
        font-weight: 600;
        line-height: 1.4;
        margin: 0;
    }

    .preview-thumbnail-container .preview-thumbnail h3 .preview-tile-title-description {
        color: <%= skinVariables['tile-title-color'] %>;
    }

    .preview-thumbnail-container .preview-thumbnail .preview-tile-metadata-description {
        color: <%= skinVariables['tile-description-color'] %>;
    }


    /************
     ** HEADER **
     ************/

    #header-logo {
        margin: 0 0 25px;
    }

    #header-greeting h1 {
        font-size: 20px;
        margin: 0;
    }

    #header-summary > div{
        margin-top: 2px;
    }


    /************
     ** FOOTER **
     ************/

    #email-footer {
        margin: 0 auto;
    }

    #email-footer #footer-container {
        font-size: 10px;
        margin-top: 40px;
        width: 500px;
    }

    #email-footer #footer-description {
        margin-bottom: 20px
    }


    /****************
     ** THUMBNAILS **
     ****************/

    .thumbnail-user img {
        height: 40px;
        width: 40px;
    }


    /****************
     ** ACTIVITIES **
     ****************/

    .activity-row {
        font-size: 12px;
    }

    .activity-row .activity-container {
        background-color: #FFF;
        border: 2px solid #ededec;
        margin: 10px auto;
        max-width: 700px;
        min-width:400px;
        padding: 30px;
    }

    .activity-row .activity-container > table {
        clear: both;
    }

    .activity-row .activity-container .activity-thumbnail-container {
        float: left;
    }

    .activity-row .activity-container .activity-summary-container {
        padding-left: 52px;
        word-wrap: break-word;
    }

    .activity-row .activity-container .activity-summary-container .activity-date {
        font-size: 11px;
        margin-top: 5px;
    }

    .activity-row .activity-container .activity-previews-container {
        margin-top: 25px;
    }

    .activity-row .activity-container .activity-comment-container {
        margin-top: 25px;
        min-height: 40px;
    }

    .activity-row .activity-container .activity-comment-container.comment-level-1 {
        margin-left: 40px;
    }

    .activity-row .activity-container .activity-comment-container.comment-level-2 {
        margin-left: 80px;
    }

    .activity-row .activity-container .activity-comment-container .activity-comment-thumbnail-container {
        float: left;
    }

    .activity-row .activity-container .activity-comment-container .activity-comment-summary-container {
        padding-left: 52px;
        word-wrap: break-word;
    }

    .activity-row .activity-container .activity-comment-container .activity-comment-summary-container .activity-comment {
        margin-top: 7px;
    }

</style>

<%
    /**
     * Truncate a string to the specified amount of characters and add three dots at the end
     */
    var truncateText = function(text, maxChars) {
        text.length > maxChars ? text = text.substring(0, maxChars) + '...' : null;
        return text;
    }
%>

<%
    /**
     * Render the email header
     */
    var renderHeader = function() {
        var institutionalLogoURL = getAbsoluteThumbnailUrl(skinVariables['institutional-logo-url'].replace(/\'/g, ''));

        var str = '';
        str += '<tr>';
        str +=     '<td align="center">';
        str +=         '<img src="' + institutionalLogoURL + '" id="header-logo" height="50"/>';
        str +=     '</td>';
        str += '</tr>';
        str += '<tr id="header-greeting">';
        str +=     '<td align="center">';
        str +=         '<h1>Hi ' + user.displayName + '</h1>';
        str +=     '</td>';
        str += '</tr>';
        str += '<tr>';
        if (user.emailPreference !== 'immediate') {
            str += '<td id="header-summary" align="center">';
            str +=     '<div class="muted">';
            if (user.emailPreference === 'daily') {
                str += 'Here\'s your summary of todays activity';
            } else if (user.emailPreference === 'weekly') {
                str += 'Here\'s your summary of last week\'s activity';
            }
            str +=     '</div">';
            str += '</td>';
        }
        str += '</tr>';
        print(str);
    };
%>

<%
    /**
     * Render the email footer
     */
    var renderFooter = function() {
        var copyrightSymbolI18n = util.i18n.translate('COPYRIGHT_SYMBOL');
        var apereoFoundationI18n = util.i18n.translate('APEREO_FOUNDATION');

        var str = '';
        str += '<td align="center">';
        str +=     '<div id="footer-container">';
        str +=         '<div id="footer-description">You can change your <a href="' + baseUrl + '/me?mypreferences" title="Your email preferences">email preferences</a> anytime.</div>';
        str +=         '<div>' + copyrightSymbolI18n + ' ' + new Date().getFullYear() + ' ' + apereoFoundationI18n + '.</div>';
        str +=     '</div>';
        str += '</td>';
        print(str);
    };
%>

<%
    /**
     * Return a thumbnail URL by checking the URL that is passed in and return it as-is
     * or prepending the baseURL to it based on if it starts with `http` or `https`.
     *
     * @param  {String}    thumbnailUrl    thumbnailUrl to check get the valid, full, URL for and return
     *
     * @return {String}                    Valid URL that points to the thumbnail
     */
    var getAbsoluteThumbnailUrl = function(thumbnailUrl) {
        if (thumbnailUrl.startsWith('https') ||
            thumbnailUrl.startsWith('http')) {
            return thumbnailUrl;
        } else {
            return baseUrl + thumbnailUrl;
        }
    }
%>

<%
    /**
     * Render the user thumbnail picture
     *
     * @param  {Object}    userProfile    The user profile information
     */
    var renderUserThumbnail = function(userProfile) {
        var thumbnailUrl = baseUrl + '/ui/img/icons/user.png';
        if (userProfile && userProfile.thumbnailUrl) {
            thumbnailUrl = getAbsoluteThumbnailUrl(userProfile.thumbnailUrl);
        } else if (userProfile && userProfile['oae:thumbnail']) {
            thumbnailUrl = getAbsoluteThumbnailUrl(userProfile['oae:thumbnail'].url);
        }

        var profilePath = baseUrl;
        if (userProfile && userProfile.profilePath) {
            profilePath += userProfile.profilePath;
        } else if (userProfile && userProfile['oae:profilePath']) {
            profilePath = baseUrl + userProfile['oae:profilePath'];
        }

        var str = '';
        str += '<a class="thumbnail-user" href="' + profilePath +  '" title="' + userProfile.displayName + '">';
        str += '    <img src="' + thumbnailUrl + '" alt="' + userProfile.displayName + '" />';
        str += '</a>';
        print(str);
    };
%>

<%
    /**
     * Render the preview thumbnail picture
     *
     * @param  {Object}    entity    The preview profile information
     * @param  {Boolean}   wide      Whether or not to render the wide content preview, defaults to `false`
     */
    var renderPreviewThumbnail = function(entity, wide) {
        var thumbnailUrl = '';

        if (wide && entity['oae:wideImage']) {
            thumbnailUrl = baseUrl + entity['oae:wideImage'];
        } else if (!wide && entity.thumbnailUrl) {
            thumbnailUrl = baseUrl + entity.thumbnailUrl;
        } else {
            wide = false;
            var resourceType = entity.resourceType;
            if (resourceType === 'content') {
                resourceType = entity.resourceSubType;
            }
            thumbnailUrl = baseUrl + '/ui/img/icons/' + resourceType + '.png';
        }

        var fillClass = '';
        if (entity.thumbnailUrl) {
            fillClass = 'thumbnail-fill';
        }

        var str = '';
        str += '<td class="preview-thumbnail-container" height="162" width="' + (wide ? '450': '162') + '" background="' + thumbnailUrl+ '" valign="bottom">';
        str +=     '<div class="preview-thumbnail">';
        str +=         '<img src="' + baseUrl + '/ui/img/icons/' + entity.visibility + '.png" alt="' + entity.visibility + '" style="float:right;width:18px;height:18px;"/>'
        str +=         '<h3>';
        str +=             '<a href="' + baseUrl + entity.profilePath + '" title="' + entity.displayName + '" target="_blank" class="preview-tile-title-description">' + truncateText(entity.displayName, 80) + '</a>';
        str +=         '</h3>';
        str +=         '<small class="preview-tile-metadata-description">' + entity.objectType + '</small>';
        str +=     '</div>';
        str += '</td>';
        print(str);
    };
%>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http: //www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http: //www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width"/>
    </head>
    <body>
        <table>
            <tbody>
                <% renderHeader() %>
                <% _.each(activities, function(activity) { %>
                    <tr class="activity-row">
                        <td>
                            <div class="activity-container">
                                <table>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div class="activity-thumbnail-container">
                                                    <% renderUserThumbnail(activity.primaryThumbnail); %>
                                                </div>
                                                <div class="activity-summary-container">
                                                    <div><% print(util.i18n.translate(activity.summary.i18nKey, activity.summary.i18nArguments)) %></div>
                                                    <div class="activity-date" class="muted"><%= (new Date(activity.created)).toDateString() %></div>
                                                </div>
                                                <table class="activity-previews-container">
                                                    <tbody>
                                                        <tr>
                                                            <%
                                                                _.each(activity.thumbnails, function(thumbnail, index) {
                                                                    if (index + 1 <= 6) {
                                                                        if (!(index % 3)) {
                                                                            print('<tr>')
                                                                        }

                                                                        renderPreviewThumbnail(thumbnail, activity.thumbnails.length === 1);

                                                                        if (!((index + 1) % 3) && index !== 0) {
                                                                            print('</tr>')
                                                                        }
                                                                    }
                                                                });
                                                            %>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <% _.each(activity.comments, function(comment) {
                                                    %>
                                                    <div class="activity-comment-container comment-level-<%= comment['oae:level'] %>">
                                                        <div class="activity-comment-thumbnail-container">
                                                            <% renderUserThumbnail(comment.author); %>
                                                        </div>
                                                        <div class="activity-comment-summary-container">
                                                            <div>
                                                                <a href="<%= baseUrl + comment.author['oae:profilePath'] %>" title="<%= comment.author.displayName %>"><%= comment.author.displayName %></a> <span class="activity-date muted"><%= (new Date(activity.created)).toDateString() %></span>
                                                                <div class="activity-comment"><%= comment.content.replace(/\n/g, '<br/>') %></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                <% }); %>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                <% }); %>
                <tr id="email-footer">
                    <% renderFooter() %>
                </tr>
            </tbody>
        </table>
    </body>
</html>
