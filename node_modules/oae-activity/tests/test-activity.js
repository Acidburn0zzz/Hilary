/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var _ = require('underscore');
var assert = require('assert');

var log = require('oae-logger').logger('test-activity');
var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

var ActivityAPI = require('oae-activity');

describe('Activity', function() {

    // Rest context that can be used for anonymous requests on the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;

    /*!
     * @param   {Object}    overlay     Configuration properties with which to overide the default.
     * @return  {Object}                An object that represents the default configuration for unit tests, overridden by the overlay.
     */
    var createDefaultConfig = function(overlay) {
        return _.extend({
            'allowAnonCollection': true,
            'collectionPollingFrequency': -1
        }, overlay);
    };

    /**
     * Function that will fill up the tenant admin and anymous rest context
     */
    before(function(callback) {
        // Fill up the anonymous cam rest context
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up global admin rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        callback();
    });

    describe('Activity API', function() {

        describe('#refreshConfiguration()', function() {

            /**
             * Test that verifies that refreshing configuration to disable activities works properly. This test assumes that an activity is
             * generated when a content item is created.
             */
            it('verify disabling and enabling activity worker', function(callback) {

                // First disable the activity worker and ensure no activities are processed
                ActivityAPI.refreshConfiguration(createDefaultConfig({'processActivityJobs': false}), function(err) {
                    assert.ok(!err);

                    var jackUsername = TestsUtil.generateTestUserId('jack');
                    RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                        assert.ok(!err);
                        var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                        // Try to generate an activity for Jack's feed
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                            assert.ok(!err);

                            // Verify no activity is generated
                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                assert.ok(!err);
                                assert.ok(activityStream);
                                assert.ok(activityStream.items);
                                assert.equal(activityStream.items.length, 0);

                                // Re-enable the worker and verify activities get generated again
                                ActivityAPI.refreshConfiguration(createDefaultConfig(), function(err) {
                                    assert.ok(!err);

                                    // Try and generate another activity for Jack's feed
                                    RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                                        assert.ok(!err);

                                        // Verify it was generated
                                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                            assert.ok(!err);
                                            assert.ok(activityStream);
                                            assert.ok(activityStream.items);
                                            assert.equal(activityStream.items.length, 1);
                                            
                                            // Re-enable the worker (again) and verify activities still get generated
                                            ActivityAPI.refreshConfiguration(createDefaultConfig(), function(err) {
                                                assert.ok(!err);

                                                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                                                    assert.ok(!err);

                                                    // Verify it was generated. 2 activities should have been generated for that jack guy now
                                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                        assert.ok(!err);
                                                        assert.ok(activityStream);
                                                        assert.ok(activityStream.items);
                                                        assert.equal(activityStream.items.length, 1);
                                                        // Verify we aggregated and added the second content item
                                                        assert.equal(activityStream.items[0].object['oae:collection'].length, 2);
                                                        callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });

            /**
             * Test that verifies that the activity TTL expiry works.
             */
            it('verify activity ttl deletes an activity after the expiry time', function(callback) {
                // Set expiry to the smallest possible, 1 second
                ActivityAPI.refreshConfiguration(createDefaultConfig({'activityTtl': 1}), function(err) {
                    assert.ok(!err);

                    var jackUsername = TestsUtil.generateTestUserId('jack');
                    RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                        assert.ok(!err);
                        var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                        // Try to generate an activity for Jack's feed
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                            assert.ok(!err);

                            // Verify the activity is generated immediately
                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                assert.ok(!err);
                                assert.ok(activityStream);
                                assert.ok(activityStream.items);
                                assert.equal(activityStream.items.length, 1);

                                // Now wait for the expiry and verify it has disappeared
                                setTimeout(RestAPI.Activity.getCurrentActivityStream, 1000, jackCtx, null, function(err, activityStream) {
                                    assert.ok(!err);
                                    assert.ok(activityStream);
                                    assert.ok(activityStream.items);
                                    assert.equal(activityStream.items.length, 0);

                                    // Hooray! Set the TTL back to the default.
                                    ActivityAPI.refreshConfiguration(createDefaultConfig(), function(err) {
                                        assert.ok(!err);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        describe('#registerActivityEntityProducer()', function() {
            /**
             * Test that verifies you cannot register duplicate activity object producers
             */
             it('verify registering duplicate activity object producers results in an error', function(callback) {
                var testId = TestsUtil.generateTestUserId();
                ActivityAPI.registerActivityEntityProducer(testId, function() { });
                assert.throws(function() {
                    ActivityAPI.registerActivityEntityProducer(testId, function() { });
                });
                callback();
             });
        });

        describe('#registerActivityEntityProducer()', function() {
            /**
             * Test that verifies you cannot register duplicate activity routers
             */
             it('verify registering duplicate activity routers results in an error', function(callback) {
                var testId = TestsUtil.generateTestUserId();
                ActivityAPI.registerActivityRouter(testId, function() { });
                assert.throws(function() {
                    ActivityAPI.registerActivityRouter(testId, function() { });
                });
                callback();
             });
        });
    });

    describe('Activity Stream Permissions', function() {

        /**
         * Test that verifies you cannot view another user's activity stream
         */
        it('verify a user activity stream can only be seen by the user themselves', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');

            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Generate an activity for Jack's feed
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    // Sanity check that Jack can view his own feed
                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                        assert.ok(!err);
                        assert.ok(activityStream);
                        assert.ok(activityStream.items);
                        assert.equal(activityStream.items.length, 1);

                        // Create Jane and make sure she cannot see Jack's feed
                        RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                            assert.ok(!err);
                            var janeCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, janeUsername, 'password');

                            RestAPI.Activity.getActivityStream(janeCtx, jack.id, null, function(err, activityStream) {
                                assert.ok(err);
                                assert.equal(err.code, 401);
                                assert.ok(!activityStream);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies only members of a group can see the group's activity feed
         */
        it('verify a group activity stream can only be seen by its members', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');
            var groupAlias = TestsUtil.generateTestUserId('group');

            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create Jane, she should not be able to see the group's feed as she will not be a member of the group
                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);
                    var janeCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, janeUsername, 'password');

                    // Create a group with which to share content
                    RestAPI.Group.createGroup(jackCtx, groupAlias, groupAlias, groupAlias, 'public', 'no', [], [], function(err, group) {
                        assert.ok(!err);

                        // Create a content item in the group library, this should route a "content created" activity to the group's activity feed
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [group.id], function(err, link) {
                            assert.ok(!err);

                            // Verify Jack can see the activity in the group feed
                            RestAPI.Activity.getActivityStream(jackCtx, group.id, null, function(err, activityStream) {
                                assert.ok(!err);
                                assert.ok(activityStream);
                                assert.equal(activityStream.items.length, 2);

                                RestAPI.Activity.getActivityStream(janeCtx, group.id, null, function(err, activityStream) {
                                    assert.ok(err);
                                    assert.equal(err.code, 401);
                                    assert.ok(!activityStream);
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Activity Stream Aggregation', function() {

        /**
         * Test that verifies when the aggregation expiry time has exceeded, a new activity will be created when it matches a pivot
         * rather than continuing to aggregate in the previous activity.
         */
        it('verify aggregation idle expiry time', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Set the aggregate expiry time to 1 second. This should give us enough time to aggregate 2 activities, wait for expiry, then create a 3rd to verify it does not aggregate.
            ActivityAPI.refreshConfiguration(createDefaultConfig({'aggregateIdleExpiry': 1000}), function(err) {
                assert.ok(!err);

                RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                    assert.ok(!err);
                    var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                    RestAPI.Content.createLink(jackCtx, 'A', 'A', 'public', 'http://www.google.ca', [], [], function(err, linkA) {
                        assert.ok(!err);

                        RestAPI.Content.createLink(jackCtx, 'B', 'B', 'public', 'http://www.google.ca', [], [], function(err, linkB) {
                            assert.ok(!err);

                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                assert.ok(!err);

                                // Verify both creates are aggregated into 1 activity
                                assert.equal(activityStream.items.length, 1);

                                // Let the aggregation timeout expire and create a new link
                                setTimeout(RestAPI.Content.createLink, 2100, jackCtx, 'C', 'C', 'public', 'http://www.google.ca', [], [], function(err, linkC) {
                                    assert.ok(!err);

                                    // Re-collect and verify that the aggregate expired, thus making the link a new activity, not an aggregate
                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                        assert.ok(!err);

                                        // Reset the activity configuration to the defaults
                                        ActivityAPI.refreshConfiguration(createDefaultConfig(), function(err) {
                                            assert.ok(!err);

                                            // Now validate the activity stream contents
                                            assert.equal(activityStream.items.length, 2);

                                            var entity = activityStream.items[0].object;
                                            assert.equal(entity['oae:id'], linkC.contentId);

                                            var hasA = false;
                                            var hasB = false;

                                            entity = activityStream.items[1].object;
                                            assert.ok(entity['oae:collection']);
                                            entity['oae:collection'].forEach(function(collectedEntity) {
                                                if (collectedEntity['oae:id'] === linkA.contentId) {
                                                    hasA = true;
                                                } else if (collectedEntity['oae:id'] === linkB.contentId) {
                                                    hasB = true;
                                                }
                                            });

                                            assert.ok(hasA);
                                            assert.ok(hasB);

                                            callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
        
