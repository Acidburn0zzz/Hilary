/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var passport = require('passport');

var AuthzUtil = require('oae-authz/lib/util');
var Context = require('oae-context').Context;
var OAE = require('oae-util/lib/oae');
var PrincipalsAPI = require('oae-principals');
var Tenant = require('oae-tenants/lib/model').Tenant;
var User = require('oae-principals/lib/model').User;

var AuthenticationUtil = require('oae-authentication/lib/util');

module.exports = function(app, callback) {
    // Attach the Authentication middleware to the global admin server.
    AuthenticationUtil.setupAuthMiddleware(app.server, OAE.serverTenant);

    // Setup the passport serializers.
    setupPassport();

    // We're done.
    callback();
};

/**
 * Sets up the serialization methods for passport.
 * This should only be run onces.
 */
var setupPassport = function() {
    // This method will determine what goes into the cookie.
    // We only need the principalId in there.
    passport.serializeUser(function(user, done) {
        done(null, user.id);
    });

    // A user has a cookie with a principalId in it.
    // By returning the user (from the DB) to the done callback
    // it will be set on the request at request.user
    passport.deserializeUser(function(principalId, done) {
        var principal = AuthzUtil.getPrincipalFromId(principalId);
        var tenant = new Tenant(principal.tenantId);
        PrincipalsAPI.getUser(new Context(tenant, new User(principal.tenantId, principalId)), principalId, function (err, user) {
            if (!err) {
                done(null, user);
            } else if (err && err.code === 404) {
                done(null, false);
            } else {
                done(err);
            }
        });
    });
};
