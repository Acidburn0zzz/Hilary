Because of some of the complications surrounding multi-tenant authentication using
Shibboleth, this document outlines what the workflow and requirements look like.


Pre-requisites:
    -   Apache + mod_shib is running on the load balancer
    -   There is a single URL that is shib protected. In our documentation this is called
        the "SP tenant". In this documentation it's assumed that this tenant runs
        at `shib-sp.oae.com`.
    -   You have registered your SP with all the necessary federations. This document will
        not deal with how that works


Reasons for having a special "SP tenant" domain:
    Shibboleth demands that service providers declare what URLs they operate on. This is required
    so IdPs know where to send a users back too once they've authenticated on their end.
    It's certainly possible to register all the URLs for which we have tenants that will use Shibboleth.
    This however does not scale and is simply not practical.
    Each time we add a shib-enabled tenant we would have to:
        -   Add an apache vhost (manageable via puppet)
        -   Update our Shibboleth metadata (sort of manageable via puppet)
        -   Update our Shibboleth metadata with the various federations our SP is part of
            This really doesn't scale as it involves mailing, calling, writing, .. various organizations
            who all have to sanity check our data.

    Regardless of the above reasons which given enough automation and user effort might be doable, there are
    also technical implementations due to the OAE ideology. Keep in mind that the goal for OAE is to have
    lots of tenants on 1 physical installation (think in the area of 5000+). Registering the Shibboleth URLs
    (roughly 6 per tenant) would result in us having to register over 30000 URLs with the various federations.
    Even if the federations would allow it, it would create such a huge increase in their metadata files it would
    almost certainly create issues.

    Having one domain that gets registered with the various federations/IdPs will allow us to:
        -   only register that domain once
        -   enable shibboleth-on-the-fly for tenants whose IdP is part of a federation our SP is part of
        -   massively reduce configuration complexity



Setup:
    -   An OAE tenant is running at `tenant.oae.com`
        -   It's configured to use Shibboleth for its authentication
        -   It's configured to use the Shibboleth Identity Provider with entityID:
            `https://idp.university.edu/shibboleth`
    -   Our "SP tenant" is running at `shib-sp.oae.com` with `https://shib-sp.oae.com/shibboleth`
        as its entityID
    -   Nginx is our main load balancer
    -   Nginx proxies all requests to Hilary
        -   Except for the following who get proxied to Apache + mod_shib
            -   `/Shibboleth.sso/*`
                Deals with Shibboleth login/metadata/logout/...
            -   `/api/auth/shibboleth/sp/returned`.


Authentication flow:
This is a 5 step process.

1. The user clicks the "Sign in with Shibboleth"-button. This takes him to
`https://tenant.oae.com/api/authentication/shibboleth`. This endpoint will forward the
user to `https://shib-sp.oae.com/api/auth/shibboleth/sp?tenantAlias=tenant&signature=...&expires=...`

2. The user arrives at `https://shib-sp.oae.com/api/auth/shibboleth/sp?tenantAlias=tenant&signature=...&expires=...`
He is now on the "SP tenant". Because the tenant alias is provided, the "SP tenant" knows where this user came from.
It will send a cookie to the user to persist that tenant alias. This is done, so when the user comes back from the IdP,
the "SP tenant" will know which tenant url to forward the user to.

The endpoint will redirect the user to `https://shib-sp.oae.com/Shibboleth.sso/Login?entityID=https://idp.university.edu/shibboleth&target=/api/authentication/shibboleth/sp/returned`. This gives mod_shib enough information to redirect
the user to the correct IdP and where to send the user back to.

3. The user authenticates on the IdP and gets sent back to `https://shib-sp.oae.com/api/auth/shibboleth/sp/returned`

4. The user arrives at `https://shib-sp.oae.com/api/auth/shibboleth/sp/returned`. Nginx will proxy this request
to Apache+mod_shib for validation. If that succeeds, Apache will proxy a request with all the necessary attributes to
`https://shib-sp.oae.com/api/auth/shibboleth/sp/callback`. This endpoint is responsible for taking all those attributes
and retrieving or creating the proper user object. Once that's done, this endpoint will redirect the user to
`https://tenant.oae.com/api/auth/shibboleth/callback?userId=..&signature=..&expires=..`. It knows what the tenant hostname
is because it can use the cookie-persisted tenant alias to look up the tenant information.

5. The user arrives at `https://tenant.oae.com/api/auth/shibboleth/callback?userId=..&signature=..&expires=..`.
The user is now on their original tenant, the endpoint will verify the userid and signature and will authenticate the user
into the system. Eventually the user gets redirected to the `/me` page (or the `redirectUrl` if one was specified in step 1).
