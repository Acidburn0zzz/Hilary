var _ = require('underscore');
var async = require('async');
var fs = require('fs');
var request = require('request');
var util = require('util');

var locations = ['Paris', 'Amsterdam', 'Bruges', 'Ghent', 'London', 'Oxford', 'Canterbury', 'Camberley', 'Gillingham', 'Cologne'];


var writeData = module.exports.writeData = function(callback) {
    getPage(function(err, items) {
        if (err) {
            console.log(err);
            return;
        }

        console.log(items);

        fs.writeFile('data.json', JSON.stringify(items, null, 4), function() {
            console.log('Base JSON file written');
        });

        // Get the location names
        //async.mapSeries(items, getLocationData, function(err, results) {
        console.log('Locations retrieved');
        _.each(items, function(item) {
            item.location = locations[Math.floor(Math.random() * locations.length)];
        });
        console.log(items);
        console.log('0000000000000');
        fs.writeFile('data_with_locations.json', JSON.stringify(items, null, 4), function() {
            console.log('File locations written');
        });

        // Get the images
        async.mapSeries(items, getImage, function(err, results) {
            console.log('Images retrieved');
            console.log(results);
            console.log('----------');
        });
        //});
    });
};
var getLocationData = function(item, callback) {
    var uri = encodeURIComponent(item.location);
    var options = {
        'url': 'http://collection.britishmuseum.org/resource?uri=' + uri + '&format=json',
        'headers': {
            'Accept': 'application/json'
        }
    };
    request(options, function(err, response, body) {
        if (!err) {
            try {
                item.body = JSON.parse(body);
            } catch (err) {
                item.body = {};
            }
        }
        return callback(err, item);
    });
};

var getImage = function(item, callback) {
    var writeStream = fs.createWriteStream('images/' + item.image.split('/').pop());
    request(item.image).pipe(writeStream);

    // The image has been written
    writeStream.on('finish', function() { return callback(null, item); });
};

var getPage = function(callback) {
    var url = 'http://collection.britishmuseum.org/sparql.json?query=PREFIX+ecrm%3A+%3Chttp%3A%2F%2Ferlangen-crm.org%2Fcurrent%2F%3E%0D%0APREFIX+skos%3A+%3Chttp%3A%2F%2Fwww.w3.org%2F2004%2F02%2Fskos%2Fcore%23%3E%0D%0APREFIX+bmo%3A+%3Chttp%3A%2F%2Fcollection.britishmuseum.org%2Fid%2Fontology%2F%3E%0D%0APREFIX+crm%3A+%3Chttp%3A%2F%2Ferlangen-crm.org%2Fcurrent%2F%3E%0D%0ASELECT+DISTINCT+%3Fimage+%3Fdescription+%3FcollectionId%7B%0D%0A%3Fobj+crm%3AP108i_was_produced_by+%3Fcu+.%0D%0A%3Fcu+crm%3AP9_consists_of+%3Fcult+.%0D%0A%3Fcult+crm%3AP10_falls_within+%3Fcultur+.%0D%0A%3Fcultur+skos%3AprefLabel+%27Roman%27+.%0D%0A%3Fobj+bmo%3APX_has_main_representation+%3Fimage+.%0D%0A%3Fobj+bmo%3APX_physical_description+%3Fdescription+.%0D%0A%3Fobj+crm%3AP1_is_identified_by+%3Fid.%0D%0A%3Fid+rdfs%3Alabel+%3FcollectionId.%0D%0A%3Fid+ecrm%3AP2_has_type+%3FidType.%0D%0AFILTER%28STR%28%3FidType%29+%3D+%27http%3A%2F%2Fcollection.britishmuseum.org%2Fid%2Fthesauri%2Fidentifier%2Fcodexid%27%29%0D%0A%7D%0D%0Alimit+300&_implicit=false&implicit=true&_equivalent=false&_form=%2Fsparql';
    console.log('Retrieving items');
    request(url, function(err, response, body) {
        if (err) {
            console.log('Bummer');
            return callback(err);
        }

        console.log('Got items');

        var items = [];
        var data = JSON.parse(body);
        _.each(data.results.bindings, function(binding) {
            items.push({
                'displayName': binding.description.value.substr(0, 50),
                'description': binding.description.value,
                'image': binding.image.value,
                'location': 'London'
            });
        });

        return callback(null, items);
    });
};
