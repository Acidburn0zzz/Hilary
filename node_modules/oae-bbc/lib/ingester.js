var _ = require('underscore');
var fs = require('fs');
var request = require('request');

var ContentAPI = require('oae-content');
var FoldersAPI = require('oae-folders');
var log = require('oae-logger').logger('oae-acroplis');

var AcropolisAPI = require('./api');


var processFolder = module.exports.processFolder = function(ctx, callback) {
    FoldersAPI.createFolder(ctx, 'Gothic art', 'Gothic art was a style of Medieval art that developed in Northern France out of Romanesque art in the 12th century AD, led by the concurrent development of Gothic architecture. It spread to all of Western Europe, never quite effacing more classical styles in Italy. In the late 14th century, the sophisticated court style of International Gothic developed, which continued to evolve until the late 15th century. In many areas, especially Germany, Late Gothic art continued well into the 16th century, before being subsumed into Renaissance art. Primary media in the Gothic period included sculpture, panel painting, stained glass, fresco and illuminated manuscripts. The easily recognizable shifts in architecture from Romanesque to Gothic, and Gothic to Renaissance styles, are typically used to define the periods in art in all media, although in many ways figurative art developed at a different pace.\n\nThe earliest Gothic art was monumental sculpture, on the walls of Cathedrals and abbeys. Christian art was often typological in nature (see Medieval allegory), showing the stories of the New Testament and the Old Testament side by side. Saints\' lives were often depicted. Images of the Virgin Mary changed from the Byzantine iconic form to a more human and affectionate mother, cuddling her infant, swaying from her hip, and showing the refined manners of a well-born aristocratic courtly lady.', null, {}, function(err, folder) {
        if (err) {
            console.log(err);
            return callback(err);
        }

        loadContent(ctx, [folder.id], callback);
    });
};


var process = module.exports.process = function(ctx, callback) {
    loadContent(ctx, [], callback);
};

var loadContent = function(ctx, folders, callback) {
    console.log('Adding to:');
    console.log(folders);
    fs.readFile('data_with_locations.json', function(err, data) {
        if (err) {
            return callback(err);
        }

        var items = JSON.parse(data);

        items = _.uniq(items, 'image');

        var contentItems = [];
        var done = _.after(items.length, function() {
            return callback(null, contentItems);
        });



        var errorCallback = _.once(callback);

        _.each(items, function(item) {
            console.log(item);
            if (!item.image) {
                console.log('Skipping image');
                return done();
            }

            var filename = item.image.split('/').pop();

            try {
                var imageStat = fs.statSync('images/' + filename);
                var file = {
                    'size': imageStat.size,
                    'name': filename,
                    'path': '/Users/sg555/projects/apereo/oae/Hilary/images/' + filename
                };
                var extra = {
                    'location': item.location
                };
                ContentAPI.createFile(ctx, item.displayName, item.description, null, file, extra, {}, folders, function(err, contentItem) {
                    if (err) {
                        log().error({'err': err});
                        return errorCallback(err);
                    }

                    log().info({'contentItem': contentItem}, 'Created content item');
                    contentItems.push(contentItem);
                    done();
                });
            } catch (err) {
                console.log(err);
            }
        });
    });
};
