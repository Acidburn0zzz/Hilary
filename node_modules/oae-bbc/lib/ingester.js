var _ = require('underscore');
var fs = require('fs');
var request = require('request');

var ContentAPI = require('oae-content');
var FoldersAPI = require('oae-folders');
var log = require('oae-logger').logger('oae-acroplis');

var AcropolisAPI = require('./api');


var processFolder = module.exports.processFolder = function(ctx, callback) {
    FoldersAPI.createFolder(ctx, 'Kouyunjik Collection', 'Nineveh (English pronunciation: /ˈnɪn.ɪv.ə/; Akkadian: Ninwe; Classical Syriac: ܢܸܢܘܵܐ; Arabic: نينوى‎ Ninawa, Kurdish: نەینەوا, Hebrew: נִינְוֵה‎ Nin\'veih; Greek: Νινευή Nineuē; Naynuwa; Turkish: Ninova Persian: نینوا‎ Latin: Nineve) is an ancient Mesopotamian city on the eastern bank of the Tigris River, and capital of the Neo-Assyrian Empire.\n\nIt was the largest city in the world for some fifty years[1] until, after a bitter period of civil war in Assyria itself, it was sacked by an unusual coalition of former subject peoples, the Babylonians, Medes, Persians, Chaldeans, Scythians and Cimmerians in 612 BC. Its ruins are across the river from the modern-day major city of Mosul, in the Ninawa Governorate of Iraq.', null, {}, function(err, folder) {
        if (err) {
            console.log(err);
            return callback(err);
        }

        loadContent(ctx, [folder.id], callback);
    });
};


var process = module.exports.process = function(ctx, callback) {
    loadContent(ctx, [], callback);
};

var loadContent = function(ctx, folders, callback) {
    console.log('Adding to:');
    console.log(folders);
    fs.readFile('data_with_locations.json', function(err, data) {
        if (err) {
            return callback(err);
        }

        var items = JSON.parse(data);

        items = _.uniq(items, 'image');

        var contentItems = [];
        var done = _.after(items.length, function() {
            return callback(null, contentItems);
        });



        var errorCallback = _.once(callback);

        _.each(items, function(item) {
            console.log(item);
            if (!item.image) {
                console.log('Skipping image');
                return done();
            }

            var filename = item.image.split('/').pop();

            try {
                var imageStat = fs.statSync('images/' + filename);
                var file = {
                    'size': imageStat.size,
                    'name': filename,
                    'path': '/Users/sg555/projects/apereo/oae/Hilary/images/' + filename
                };
                var extra = {
                    'location': item.location
                };
                ContentAPI.createFile(ctx, item.displayName, item.description, null, file, extra, {}, folders, function(err, contentItem) {
                    if (err) {
                        log().error({'err': err});
                        return errorCallback(err);
                    }

                    log().info({'contentItem': contentItem}, 'Created content item');
                    contentItems.push(contentItem);
                    done();
                });
            } catch (err) {
                console.log(err);
            }
        });
    });
};
