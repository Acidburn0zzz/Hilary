/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var ContentDAO = require('oae-content/lib/internal/dao');
var RestAPI = require('oae-rest');
var SearchTestsUtil = require('oae-search/lib/test/util');
var TestsUtil = require('oae-tests');

var Etherpad = require('oae-content/lib/internal/etherpad');

describe('Collaboration documents', function() {

    // Rest context that can be used every time we need to make a request as an anonymous user
    var anonymousRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;

    var multipleServers = {
        'hosts': [
            {
                'apikey': '13SirapH8t3kxUh5T5aqWXhXahMzoZRA',
                'host': '0.etherpad.oae.com',
                'port': 80
            },
            {
                'apikey': '13SirapH8t3kxUh5T5aqWXhXahMzoZRA',
                'host': '1.etherpad.oae.com',
                'port': 80
            }
        ]
    };
    var testConfig = null;

    /**
     * Function that will fill up the anonymous and tenant admin REST context
     */
    before(function(callback) {
        // Fill up anonymous rest context
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up tenant admin rest contexts
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        // Get the original test config.
        testConfig = Etherpad.getConfig();
        callback();
    });

    /**
     * Verifies that the load is balanced based on the content ID.
     */
    it('verify different servers get selected depending on the content ID', function() {
        // Configure Etherpad with 2 servers, rather than the default 1.
        Etherpad.refreshConfiguration(multipleServers);

        var hostA = Etherpad.getServerHost('c:cam:abc123');
        var hostB = Etherpad.getServerHost('c:cam:abc1231');
        assert.notEqual(hostA, hostB);

        // Re-configure Etherpad with the defaults.
        Etherpad.refreshConfiguration(testConfig);
    });

    /**
     * Verifies that you can only join a collaborative document if you have viewer permissions
     */
    it('verify joining a pad respects the content permissions.', function(callback) {
        TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users) {
            assert.ok(!err);
            var simonCtx = _.values(users)[0].restContext;
            var brandenCtx = _.values(users)[1].restContext;

            // Simon creates a collaborative document that's private.
            var name = TestsUtil.generateTestUserId();
            RestAPI.Content.createCollabDoc(simonCtx, name, 'description', 'private', [], [], function(err, contentObj) {
                assert.ok(!err);

                RestAPI.Content.joinCollabDoc(simonCtx, contentObj.id, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data);

                    // Branden has no access yet, so this should be a 401
                    RestAPI.Content.joinCollabDoc(brandenCtx, contentObj.id, function(err, data) {
                        assert.equal(err.code, 401);
                        assert.ok(!data);

                        // Share it with branden.
                        var members = {};
                        members[_.keys(users)[1]] = 'viewer';
                        RestAPI.Content.updateMembers(simonCtx, contentObj.id, members, function(err) {
                            assert.ok(!err);

                            // Branden should now be able to access it.
                            RestAPI.Content.joinCollabDoc(simonCtx, contentObj.id, function(err, data) {
                                assert.ok(!err);
                                assert.ok(data);
                                callback();
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * Verifies that you can only publish a collaborative document if you have manager permissions
     */
    it('verify publishing a pad respects the content permissions.', function(callback) {
        TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users) {
            assert.ok(!err);
            var simonCtx = _.values(users)[0].restContext;
            var brandenCtx = _.values(users)[1].restContext;

            // Simon creates a collaborative document that's private.
            var name = TestsUtil.generateTestUserId();
            RestAPI.Content.createCollabDoc(simonCtx, name, 'description', 'private', [], [], function(err, contentObj) {
                assert.ok(!err);

                RestAPI.Content.publishCollabDoc(simonCtx, contentObj.id, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data);

                    // Branden has no access yet, so this should be a 401
                    RestAPI.Content.publishCollabDoc(brandenCtx, contentObj.id, function(err, data) {
                        assert.equal(err.code, 401);
                        assert.ok(!data);

                        // Share it with branden.
                        var members = {};
                        members[_.keys(users)[1]] = 'manager';
                        RestAPI.Content.updateMembers(simonCtx, contentObj.id, members, function(err) {
                            assert.ok(!err);

                            // Branden should now be able to access it.
                            RestAPI.Content.publishCollabDoc(simonCtx, contentObj.id, function(err, data) {
                                assert.ok(!err);
                                assert.ok(data);

                                // By now we should have 2 revisions (not three, as Branden's first publish was unauthorized)
                                RestAPI.Content.getRevisions(simonCtx, contentObj.id, null, null, function(err, revisions) {
                                    assert.ok(!err);
                                    assert.equal(revisions.length, 2);
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * This test verifies that the latest HTML is retrieved when publishing a collaboration document
     * It does this by creating a pad, submitting some text in etherpad, publishing the document, retrieving the new content object
     * from our API and verifying the new text is there.
     * It also performs some more etherpad edits and verifies these do not get streamed to our API.
     */
    it('verify the correct HTML is retrieved when publishing.', function(callback) {
        TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users) {
            assert.ok(!err);
            var simonCtx = _.values(users)[0].restContext;

            // Simon creates a collaborative document that's private.
            var name = TestsUtil.generateTestUserId();
            RestAPI.Content.createCollabDoc(simonCtx, name, 'description', 'private', [], [], function(err, contentObj) {
                assert.ok(!err);

                // Verify there is no HTML present yet.
                RestAPI.Content.getContent(simonCtx, contentObj.id, function(err, contentObj) {
                    assert.ok(!err);
                    assert.ok(!contentObj.collabdoc.html);

                    // Do some edits in etherpad.
                    var etherpadClient = Etherpad.getClient(contentObj.id);
                    var text = 'Only two things are infinite, the universe and human stupidity, and I am not sure about the former.';
                    var args = {
                        'padID': contentObj.collabdoc.padID,
                        'text': text
                    };
                    etherpadClient.setText(args, function(err) {
                        assert.ok(!err);

                        RestAPI.Content.publishCollabDoc(simonCtx, contentObj.id, function(err, data) {
                            assert.ok(!err);
                            assert.ok(data);

                            RestAPI.Content.getContent(simonCtx, contentObj.id, function(err, updatedContentObj) {
                                assert.ok(!err);
                                assert.ok(updatedContentObj.collabdoc.html);
                                assert.notEqual(updatedContentObj.collabdoc.html, contentObj.collabdoc.html);

                                // Remove linebreaks and check if the text is correct.
                                var html = updatedContentObj.collabdoc.html.replace('<br>', '');
                                assert.equal(html, text);

                                // If we make any further updates in etherpad they shouldn't show up yet from our API.
                                args.text = 'There are no facts, only interpretations.';
                                etherpadClient.setText(args, function(err) {
                                    assert.ok(!err);
                                    RestAPI.Content.getContent(simonCtx, contentObj.id, function(err, latestContentObj) {
                                        assert.ok(!err);
                                        assert.ok(latestContentObj.collabdoc.html);
                                        assert.equal(latestContentObj.collabdoc.html, updatedContentObj.collabdoc.html);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    it('verify that published collaboration documents are searchable', function(callback) {
        TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users) {
            assert.ok(!err);
            var simonCtx = _.values(users)[0].restContext;

            // Simon creates a collaborative document that's private.
            var name = TestsUtil.generateTestUserId('collabdoc');
            RestAPI.Content.createCollabDoc(simonCtx, name, 'description', 'private', [], [], function(err, contentObj) {
                assert.ok(!err, JSON.stringify(err, null, 4));

                RestAPI.Content.getContent(simonCtx, contentObj.id, function(err, contentObj) {
                    assert.ok(!err);
                    assert.ok(!contentObj.collabdoc.html);

                    // Do some edits in etherpad.
                    var etherpadClient = Etherpad.getClient(contentObj.id);
                    var text = 'Most modern calendars mar the sweet simplicity of our lives by reminding us that each day that passes is the anniversary of some perfectly uninteresting event.';
                    var args = {
                        'padID': contentObj.collabdoc.padID,
                        'text': text
                    };
                    etherpadClient.setText(args, function(err) {
                        assert.ok(!err);

                        RestAPI.Content.publishCollabDoc(simonCtx, contentObj.id, function(err, data) {
                            assert.ok(!err);
                            assert.ok(data);

                            SearchTestsUtil.searchAll(simonCtx, 'general', null, {'q': 'Most modern calendars', 'resourceTypes': 'content'}, function(err, data) {
                                assert.ok(!err);
                                assert.equal(data.results.length, 1);
                                assert.equal(data.results[0].id, contentObj.id);
                                callback();
                            });
                        });
                    });
                });
            });
        });
    });
});
