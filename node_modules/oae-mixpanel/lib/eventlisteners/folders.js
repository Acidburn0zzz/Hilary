/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');

var FoldersAPI = require('oae-folders');
var FoldersConstants = require('oae-folders/lib/constants').FoldersConstants;

var MixpanelUtil = require('oae-mixpanel/lib/util');

module.exports = function(client) {

    /*!
     * Retrieving a folder
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.RETRIEVED_FOLDER_PROFILE, function(ctx, folder) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        client.track(FoldersConstants.events.RETRIEVED_FOLDER_PROFILE, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.RETRIEVED_FOLDER_PROFILE);
    });

    /*!
     * Creating a folder
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.CREATED_FOLDER, function(ctx, folder, members) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        params.nrOfMembers = _.values(members).length;
        client.track(FoldersConstants.events.CREATED_FOLDER, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.CREATED_FOLDER);
    });

    /*!
     * Updating a folder
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.UPDATED_FOLDER, function(ctx, oldFolder, newFolder) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = newFolder.id;
        params.newVisibility = newFolder.visibility;
        params.oldVisibility = oldFolder.oldVisibility;
        client.track(FoldersConstants.events.UPDATED_FOLDER, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.UPDATED_FOLDER);
    });

    /*!
     * Sharing a folder / Updating its members
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.UPDATED_FOLDER_MEMBERS, function(ctx, folder, roleChanges, newMemberIds, updatedMemberIds, removedMemberIds) {
        newMemberIds = newMemberIds || [];
        updatedMemberIds = updatedMemberIds || [];
        removedMemberIds = removedMemberIds || [];

        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        params.newMembers = newMemberIds.length;
        params.updatedMembers = updatedMemberIds.length;
        params.removedMembers = removedMemberIds.length;
        client.track(FoldersConstants.events.UPDATED_FOLDER_MEMBERS, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.UPDATED_FOLDER_MEMBERS);
    });

    /*!
     * Adding items to a folder
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.ADDED_CONTENT_ITEMS, function(ctx, actionContext, folder, contentItems) {
        if (actionContext === 'add-to-folder') {
            var params = MixpanelUtil.getBasicParameters(ctx);
            params.id = folder.id;
            params.visibility = folder.visibility;
            params.nrOfContentItems = contentItems.length;
            client.track(FoldersConstants.events.ADDED_CONTENT_ITEMS, params);
            client.people.increment(params.distinct_id, FoldersConstants.events.ADDED_CONTENT_ITEMS);
        }
    });

    /*!
     * Removing items from a folder
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.REMOVED_CONTENT_ITEMS, function(ctx, folder, contentItems) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        params.nrOfContentItems = contentItems.length;
        client.track(FoldersConstants.events.REMOVED_CONTENT_ITEMS, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.REMOVED_CONTENT_ITEMS);
    });

    /*!
     * Deleting a folder
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.DELETED_FOLDER, function(ctx, folder) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        client.track(FoldersConstants.events.DELETED_FOLDER, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.DELETED_FOLDER);
    });

    /*!
     * Creating a comment
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.CREATED_COMMENT, function(ctx, message, folder) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        params.messageLength = message.body.length;
        params.isReply = _.isString(message.replyTo);
        client.track(FoldersConstants.events.CREATED_COMMENT, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.CREATED_COMMENT);
    });

    /*!
     * Deleting a comment
     */
    MixpanelUtil.listen(FoldersAPI, FoldersConstants.events.DELETED_COMMENT, function(ctx, message, folder, deleteType) {
        var params = MixpanelUtil.getBasicParameters(ctx);
        params.id = folder.id;
        params.visibility = folder.visibility;
        params.deleteType = folder.deleteType;
        params.isReply = _.isString(message.replyTo);
        client.track(FoldersConstants.events.DELETED_COMMENT, params);
        client.people.increment(params.distinct_id, FoldersConstants.events.DELETED_COMMENT);
    });
};
