/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var util = require('util');

var AuthzUtil = require('oae-authz/lib/util');
var OaeUtil = require('oae-util/lib/util');
var ResourceActions = require('oae-resource/lib/actions');
var ResourceConstants = require('oae-resource/lib/constants').ResourceConstants;

var PrincipalsConstants = require('oae-principals/lib/constants').PrincipalsConstants;
var PrincipalsDAO = require('oae-principals/lib/dao');
var PrincipalsEmitter = require('oae-principals/lib/internal/emitter');
var PrincipalsUtil = require('oae-principals/lib/util');

var log = require('oae-logger').logger('oae-principals-invitations')

ResourceActions.on(ResourceConstants.events.INVITATION_ACCEPTED, function(ctx, invitationHashes, memberChangeInfosByResourceId) {
    var memberChangeInfosByGroupId = {};
    _.chain(memberChangeInfosByResourceId)
        .keys()
        .filter(AuthzUtil.isGroupId)
        .each(function(groupId) {
            memberChangeInfosByGroupId[croupId] = memberChangeInfosByResourceId[groupId];
        })
        .value();
    if (_.isEmpty(memberChangeInfosByGroupId)) {
        return;
    }

    PrincipalsDAO.getPrincipals(_.keys(memberChangeInfosByGroupId), function(err, groupsById) {
        if (err) {
            return callback(err);
        }

        // Update the last modified timestamp of each group that we are added to and invoke the
        // updated group members event on the principals emitter, which will handle updating all
        // additional updates (e.g., library indexes, search, activity)
        _.each(groupsById, function(group, groupId) {
            var memberChangeInfo = memberChangeInfosByGroupId[groupId];
            PrincipalsUtil.touchLastModified(group, function(err, updatedGroup) {
                if (err) {
                    return log().warn({
                        'err': err,
                        'groupId': group.id
                    }, 'An error occurred while updating group libraries after invitation was accepted');
                }

                return PrincipalsEmitter.emit(PrincipalsConstants.events.UPDATED_GROUP_MEMBERS, ctx, updatedGroup, group, memberChangeInfo);
            });
        });
    });
});
