var OAE = require('oae-util/lib/OAE');
var api = require('oae-roles/lib/api');

module.exports = (function() {

    var that = {};

    that.loadSequential = function(baseTenantId, baseUserId, baseContentId, numTenants, numUserIdsPerTenant, numContentPerUserId, callback) {
        OAE.initializeKeySpace(function() {
            api.ensureSchema(function(err) {
                if (err) throw err;
                loadSequential(baseTenantId, baseUserId, baseContentId, numTenants, numUserIdsPerTenant, numContentPerUserId, callback);
            });
        });
    };

    function loadSequential(baseTenantId, baseUserId, baseContentId, numTenants, numUserIdsPerTenant, numContentPerUserId, callback) {
        if (numTenants === 0) {
            try { callback(); } catch (err) {}
            return;
        }

        var tenantId = baseTenantId+'-'+numTenants;
        var userId = baseUserId+'-'+numTenants;
        var contentId = baseContentId+'-'+numTenants;

        loadUserIdsForTenant(tenantId, userId, contentId, numUserIdsPerTenant, numContentPerUserId, function() {
            loadSequential(baseTenantId, baseUserId, baseContentId, numTenants-1, numUserIdsPerTenant, numContentPerUserId, callback);
        });
    };



    function loadUserIdsForTenant(tenantId, baseUserId, baseContentId, numUserIdsPerTenant, numContentPerUserId, callback) {
        if (numUserIdsPerTenant === 0) {
            try { callback(); } catch (err) {}
            return;
        }

        var userId = baseUserId+'-'+numUserIdsPerTenant;
        var contentId = baseContentId+'-'+numUserIdsPerTenant;
        var securityContext = new api.SecurityContext(tenantId, api.PrincipalTypes.USER, userId);

        loadContentRolesForUser(securityContext, baseContentId, numContentPerUserId, function() {
            loadUserIdsForTenant(tenantId, baseUserId, baseContentId, numUserIdsPerTenant-1, numContentPerUserId, callback);
        });
    }

    function loadContentRolesForUser(securityContext, baseContentId, numContentPerUserId, callback) {
        if (numContentPerUserId === 0) {
            try { callback(); } catch (err) {}
            return;
        }

        var contentId = baseContentId+'-'+numContentPerUserId
        securityContext.addRole(api.ObjectTypes.CONTENT, contentId, 'viewer', function(err) {
            if (!err) {
                console.log('Added one for %s...', contentId);
                loadContentRolesForUser(securityContext, baseContentId, numContentPerUserId-1, callback);
            } else {
                console.log(err);
            }
        });
    }

    return that;
})();