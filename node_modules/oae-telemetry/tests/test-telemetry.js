/*
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var TelemetryAPI = require('oae-telemetry');


describe('Telemetry', function() {

    var Telemetry = null;
    beforeEach(function(callback) {
        TelemetryAPI.reset(function(err) {
            assert.ok(!err);
            Telemetry = TelemetryAPI.telemetry('tests');
            return callback();
        });
    });

    describe('#incr()', function() {

        it('verify it increases by one', function(callback) {
            Telemetry.incr('incr', 1, function(err) {
                assert.ok(!err);
                TelemetryAPI.getTelemetryData(function(err, data) {
                    assert.ok(!err);
                    assert.equal(data['tests']['incr'], 1);
                    return callback();
                });
            });
        });

        it('verify multiple increases', function(callback) {
            Telemetry.incr('incr', 10, function(err) {
                TelemetryAPI.getTelemetryData(function(err, data) {
                    assert.ok(!err);
                    assert.equal(data['tests']['incr'], 10);
                    return callback();
                });
            });
        });

    });

    describe('#append()', function() {

        it('verify it appends data to a list', function(callback) {
            Telemetry.append('append', 10);

            TelemetryAPI.getTelemetryData(function(err, data) {
                assert.ok(!err);
                assert.equal(data['tests']['append'].length, 1);
                assert.equal(data['tests']['append'][0], 10);

                Telemetry.append('append', 5);
                TelemetryAPI.getTelemetryData(function(err, data) {
                    assert.equal(data['tests']['append'].length, 2);
                    assert.equal(data['tests']['append'][0], 10);
                    assert.equal(data['tests']['append'][1], 5);
                    return callback();
                });
            });
        });
    });
});
