/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var OAE = require('oae-util/lib/oae');

var TenantsAPI = require('oae-tenants');

module.exports = function() {
    
    //////////////////
    // Global admin //
    //////////////////

    // TODO: Remove this endpoint once the global admin UI is no longer hosted through express
    //app.server.get('/admin', function(req, res, next) {
    //    fs.readFile('node_modules/oae-config/public/admin.html', 'binary', function(err, file) {
    //        if (err) {
    //            return res.send(500, 'Page not found.');;
    //        }
    //
    //        res.contentType('text/html');
    //        res.send(file);
    //    });
    //});

    // TODO: Remove this endpoint once the global admin UI is no longer hosted through express
    //app.server.get('/admin/*', function(req, res, next) {
    //    fs.readFile('node_modules/oae-config/public/admin.html', 'binary', function(err, file) {
    //        if (err) {
    //            return res.send(500, 'Page not found.');;
    //        }
    //
    //        res.contentType('text/html');
    //        res.send(file);
    //    });
    //});

    OAE.globalAdminServer.get('/api/tenant/:tenantId', function(req, res) {
        TenantsAPI.getTenantByAlias(req.params.tenantId, function(err, tenant) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200, tenant);
        });
    });

    OAE.globalAdminServer.get('/api/tenant', function(req, res) {
        res.send(200, OAE.serverTenant);
    });

    OAE.globalAdminServer.post('/api/tenant', function(req, res) {
        TenantsAPI.updateTenant(req.ctx, req.body.port, req.body.name, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200);
        });
    });

    OAE.globalAdminServer.post('/api/tenant/create', function(req, res) {
        TenantsAPI.createTenant(req.ctx, req.body.id, req.body.name, req.body.port, req.body.baseurl, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200, 'New tenant "' + req.body.name + '" has been fired up on port ' + req.body.port);
        });
    });

    OAE.globalAdminServer.post('/api/tenant/start', function(req, res) {
        // sets the tenant to be ENABLED, by passing in 'false'
        TenantsAPI.disableTenants(req.ctx, req.body.tenants, false, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200);
        });
    });

    OAE.globalAdminServer.post('/api/tenant/stop', function(req, res) {
        // sets the tenant to be disabled, by passing in 'true'
        TenantsAPI.disableTenants(req.ctx, req.body.tenants, true, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200);
        });
    });

    OAE.globalAdminServer.post('/api/tenant/delete', function(req, res) {
        TenantsAPI.deleteTenants(req.ctx, req.body.tenants, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200);
        });
    });

    OAE.globalAdminServer.get('/api/tenants', function(req, res, next) {
        TenantsAPI.getAllTenants(function(err, tenants) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200, tenants);
        });
    });


    /////////////
    // Tenants //
    /////////////
    
    OAE.tenantAdmin.get('/api/tenant', function(req, res) {
        TenantsAPI.getTenantByAlias(req.ctx.tenant().alias, function(err, tenant) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200, tenant);
        });
    });

    OAE.tenantAdmin.post('/api/tenant', function(req, res) {
        TenantsAPI.updateTenant(req.ctx, req.body.port, req.body.name, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200);
        });
    });

    OAE.tenantAdmin.get('/api/tenants', function(req, res, next) {
        TenantsAPI.getAllTenants(function(err, tenants) {
            if (err) {
                return res.send(err.code, err.msg);
            }
            res.send(200, tenants);
        });
    });

    // TODO: Remove this endpoint once the global admin UI is no longer hosted through express
    // tenant.server.get('/admin', function(req, res, next) {
    //    fs.readFile('node_modules/oae-config/public/admin.html', 'binary', function(err, file) {
    //        if (err) {
    //            return res.send(500, 'Page not found.');;
    //        }
    //
    //        res.contentType('text/html');
    //        res.send(file);
    //    });
    //}); */
};
