/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var StaticApi = require('./api.static');

module.exports = function(tenant) {

    /**
     * Get all the aggregated widget configs.
     */
    tenant.server.get('/api/widgets', function(req, res) {
        // Get all the widget configs.
        var widgetConfigs = StaticApi.getWidgetConfigs();

        // Check if we do jsonp or just json.
        if (req.query.callback) {
            var configs = JSON.stringify(widgetConfigs);
            res.set('application/javascript');
            res.send(req.query.callback + '(' + configs + ');');
        } else {
            res.set('Content-Type', ['application/json']);
            res.send(widgetConfigs);
        }
    });

    /**
     * Get multiple static files in one request.
     */
    tenant.server.get('/api/staticfiles', function(req, res) {
        if (!req.query.files) {
            return res.send(400, 'Missing files parameter');
        }
        var files = req.query.files;
        if (!Array.isArray(files)) {
            files = [ files ];
        }

        var results = [];
        files.forEach(function(file) {
            StaticApi.getFile(file, function(err, data) {
                if (err) {
                    results.push({
                        'url': file,
                        'success': false
                    });
                } else {
                    results.push({
                        'url': file,
                        'success': true,
                        'body': data
                    });
                }

                if (results.length === files.length) {
                    res.send(200, {'results': results});
                }
            });
        });
    });
};