/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var Swagger = require('../lib/swagger');
var TestsUtil = require('oae-tests');

before(function(callback) {
    anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.localhost.host);
    // oae-util doesn't have rest endpoints so it won't be auto-registered
    var done = function() {
        Swagger.addModelsToResources();
        callback();
    };
    Swagger.documentModule('oae-util', done);
});

// Set up some sample docs that we can test

/**
 * @REST testEndpoint
 *
 * Test some stuff
 *
 * @Server      tenant
 * @Method      POST
 * @Path        /test/{foo}
 * @PathParam   {string}            var         A path parameter  [choice1, choice2]
 * @BodyParam   {string}            var2        A body parameter
 * @QueryParam  {number}            var3        A query parameter
 * @QueryParam  {string} !Required  var4        A required query parameter
 * @QueryParam  {string} !Multiple  var5        A query parameter that can appear multiple times
 * @QueryParam  {string} !Required !Multiple var6  A required query parameter that can appear multiple times
 * @HeaderParam {string}            var7        A header parameter
 * @FormParam   {string}            var8        A form parameter
 * @Return      {Test[]}                        The return value
 */

/**
 * @RESTModel Test
 *
 * A test model
 *
 * @Required    [test, test2]
 * @Property    {string}        test    A property
 * @Property    {Test2[]}       test2   Array of Test2s
 */

/**
 * @RESTModel Test2
 *
 * Another test model
 *
 * @Required    [test, num]
 * @Property    {string[]}        test    A property
 * @Property    {number}        num
 */

describe('Swagger', function() {

    describe('Resource List', function() {

        /**
         * Verifies that we get a Swagger resource list with the expected contents
         */
        it('verify get resource list', function(callback) {
            RestAPI.Doc.getSwaggerResources(anonymousRestContext, function(err, resources) {
                assert.ok(!err);
                assert.ok(_.isString(resources.apiVersion));
                assert.ok(_.isString(resources.swaggerVersion));
                assert.ok(_.isArray(resources.apis));
                _.each(resources.apis, function(api) {
                    assert.ok(_.isString(api.path));
                    assert.ok(_.isString(api.description));
                });
                assert.ok(_.find(resources.apis, function(api) {
                    return api.path === '/test';
                }, 'There should be a resource for the "/test" apis'));
                callback();
            });
        });
    });

    describe('API Declarations', function() {
        var primitives = [
            'integer',
            'long',
            'float',
            'double',
            'string',
            'byte',
            'boolean',
            'date',
            'dateTime',
            'int32',
            'int64',
            'number',
            'date-time'
        ];

        /**
         * Verifies that we can get API declarations for all defined routes
         */
        it('verify get api declarations', function(callback) {
            RestAPI.Doc.getSwaggerResources(anonymousRestContext, function(err, resources) {
                assert.ok(!err);
                assert.ok(resources.apis);
                var completed = 0;
                _.each(resources.apis, function(api) {
                    // Strip the leading '/'
                    var id = api.path.substr(1);
                    RestAPI.Doc.getSwaggerApi(anonymousRestContext, id, function(err, data) {
                        assert.ok(!err);
                        assert.ok(data.apiVersion);
                        assert.ok(data.swaggerVersion);
                        assert.equal(data.basePath, 'http://localhost:2001/api');
                        assert.equal(data.resourcePath, id + '/');
                        assert.ok(_.isArray(data.apis));
                        assert.ok(_.isObject(data.models));
                        // Verify models
                        _.each(data.models, function(model) {
                            assert.ok(_.isString(model.id), 'Model id must be a String');
                            assert.ok(_.isArray(model.required), 'Model required must be an Array');
                            assert.ok(_.isObject(model.properties), 'Model properties must be an Object');
                            _.each(model.required, function(id) {
                                assert.ok(_.isString(id), 'Required property ids must be Strings');
                                assert.ok(model.properties[id], 'Required property "' + id + '" is not defined');
                            });
                            _.each(model.properties, function(property) {
                                assert.ok(_.isString(property.type));
                                if (property.type === 'array') {
                                    assert.ok(_.isObject(property.items), 'Arrays must have an item type');
                                    // Arrays have a type xor $ref
                                    assert.ok(_.has(property.items, 'type') ^ _.has(property.items, '$ref'), 'Item must have a type or a $ref but not both');
                                    if (property.items.type) {
                                        assert.ok(primitives.indexOf(property.items.type) !== -1, 'Array item type "' + property.items.type + '" is not a primitive type, did you mean $ref');
                                    } else {
                                        // Complex type, make sure there's a model for it
                                        assert.ok(data.models[property.items['$ref']], 'Array item $ref "' + property.items['$ref'] + '" is not defined in models');
                                    }
                                } else if (primitives.indexOf(property.type) === -1) {
                                    // Complex type, make sure there's a model for it
                                    assert.ok(data.models[property.type], 'Property type "' + property.type + '" is not defined in models');
                                }
                            });
                        });

                        // Verify apis
                        _.each(data.apis, function(api) {
                            assert.ok(_.isObject(api), 'APIs must be Objects');
                            assert.ok(_.isString(api.path), 'API paths must be Strings');
                            assert.ok(_.isArray(api.operations), 'API operations must be an Array');
                            _.each(api.operations, function(operation) {
                                assert.ok(_.isObject(operation), 'Operations must be Objects');
                                assert.ok(_.isString(operation.path), 'Operation path must be a String');
                                var verbs = ['GET', 'POST', 'PUT', 'DELETE'];
                                assert.ok(verbs.indexOf(operation.method) !== -1, 'Operation method "' + operation.method + '" is not one of "GET", "POST", "PUT", or "DELETE"');
                                assert.ok(_.isString(operation.nickname), 'Operation nickname must be a String');
                                assert.ok(operation.nickname.indexOf(' ') === -1, 'Operation nickname "' + operation.nickname + '" cannot contain spaces');
                                assert.ok(_.isString(operation.summary), 'Operation summary must be a String');
                                assert.ok(_.isString(operation.responseClass), 'Operation responseClass must be a String');
                                var responseClass = operation.responseClass.replace(/^List\[/, '').replace(/\]/, '');
                                if (primitives.indexOf(responseClass) === -1) {
                                    assert.ok(data.models[responseClass], 'ResponseClass type "' + responseClass + '" is undefined in models');
                                }

                                assert.ok(_.isArray(operation.parameters), 'Operation parameters must be an Array');
                                _.each(operation.parameters, function(parameter) {
                                    assert.ok(_.isString(parameter.name), 'Parameter name must be a String');
                                    assert.ok(_.isString(parameter.description), 'Parameter description must be a String');
                                    var dataType = parameter.dataType.replace(/^List\[/, '').replace(/\]/, '');
                                    if (primitives.indexOf(dataType) === -1) {
                                        assert.ok(data.models[dataType], 'Parameter dataType "' + dataType + '" is undefined in models');
                                    }
                                    assert.ok(_.isBoolean(parameter.required), 'Parameter required must be a Boolean');
                                    assert.ok(_.isBoolean(parameter.allowMultiple), 'Parameter allowMultiple must be a Boolean');
                                    var paramTypes = ['body', 'path', 'query', 'form', 'header'];
                                    assert.ok(paramTypes.indexOf(parameter.paramType !== -1), 'Param type "' + parameter.paramType + '" is not one of "body", "path", "query", "form", or "header"');
                                    if (parameter.paramType === 'path') {
                                        assert.ok(api.path.indexOf('{' + parameter.name + '}') !== 0, 'Path parameter "' + parameter.name + '" does not appear in api path');
                                    }

                                    if (['path', 'query', 'header'].indexOf(parameter.paramType) !== -1) {
                                        assert.ok(primitives.indexOf(parameter.dataType) !== -1, parameter.paramType + ' parameter "' + parameter.name + '" must be of a primitive type');
                                    }
                                });
                            });
                        });

                        completed++;
                        if (completed === resources.apis.length) {
                            // Verify the "test" api documentation
                            RestAPI.Doc.getSwaggerApi(anonymousRestContext, 'test', function(err, data) {
                                assert.ok(!err);
                                assert.equal(data.apis.length, 1);
                                assert.equal(data.apis[0].operations.length, 1);
                                var operation = data.apis[0].operations[0];
                                assert.equal(data.apis[0].path, '/test/{foo}');
                                assert.equal(data.apis[0].description, 'Test some stuff');
                                assert.equal(operation.summary, 'Test some stuff');
                                assert.equal(operation.server, 'tenant');
                                assert.equal(operation.httpMethod, 'POST');
                                assert.equal(operation.nickname, 'testEndpoint');
                                assert.equal(operation.responseClass, 'List[Test]');
                                assert.equal(operation.parameters.length, 8);
                                var params = _.indexBy(operation.parameters, 'name');
                                // Verify a path parameter
                                assert.equal(params['var'].description, 'A path parameter');
                                assert.equal(params['var'].dataType, 'string');
                                assert.ok(params['var'].required);
                                assert.ok(!params['var'].allowMultiple);
                                assert.equal(params['var'].allowableValues.valueType, 'LIST');
                                assert.equal(params['var'].allowableValues.values.length, 2);
                                assert.ok(_.contains(params['var'].allowableValues.values, 'choice1'));
                                assert.ok(_.contains(params['var'].allowableValues.values, 'choice2'));
                                assert.equal(params['var'].paramType, 'path');
                                // Verify a body parameter
                                assert.equal(params.var2.description, 'A body parameter');
                                assert.equal(params.var2.dataType, 'string');
                                assert.ok(params.var2.required);
                                assert.ok(!params.var2.allowMultiple);
                                assert.equal(params.var2.paramType, 'body');
                                // Verify a query parameter
                                assert.equal(params.var3.description, 'A query parameter');
                                assert.equal(params.var3.dataType, 'number');
                                assert.ok(!params.var3.required);
                                assert.ok(!params.var3.allowMultiple);
                                assert.equal(params.var3.paramType, 'query');
                                // Verify a required query parameter
                                assert.equal(params.var4.description, 'A required query parameter');
                                assert.equal(params.var4.dataType, 'string');
                                assert.ok(params.var4.required);
                                assert.ok(!params.var4.allowMultiple);
                                assert.equal(params.var4.paramType, 'query');
                                // Verify a query parameter that can appear multiple times
                                assert.equal(params.var5.description, 'A query parameter that can appear multiple times');
                                assert.equal(params.var5.dataType, 'string');
                                assert.ok(!params.var5.required);
                                assert.ok(params.var5.allowMultiple);
                                assert.equal(params.var5.paramType, 'query');
                                // Verify a required query parameter that can appear multiple times
                                assert.equal(params.var6.description, 'A required query parameter that can appear multiple times');
                                assert.equal(params.var6.dataType, 'string');
                                assert.ok(params.var6.required);
                                assert.ok(params.var6.allowMultiple);
                                assert.equal(params.var6.paramType, 'query');
                                // Verify a header parameter
                                assert.equal(params.var7.description, 'A header parameter');
                                assert.equal(params.var7.dataType, 'string');
                                assert.ok(!params.var7.required);
                                assert.ok(!params.var7.allowMultiple);
                                assert.equal(params.var7.paramType, 'header');
                                // Verify a form parameter
                                assert.equal(params.var8.description, 'A form parameter');
                                assert.equal(params.var8.dataType, 'string');
                                assert.ok(params.var8.required);
                                assert.ok(!params.var8.allowMultiple);
                                assert.equal(params.var8.paramType, 'form');

                                // Verify the models
                                assert.equal(_.size(data.models), 2);
                                assert.equal(data.models.Test.id, 'Test');
                                assert.equal(data.models.Test.description, 'A test model');
                                assert.equal(data.models.Test.required.length, 2);
                                assert.ok(_.contains(data.models.Test.required, 'test'));
                                assert.ok(_.contains(data.models.Test.required, 'test2'));
                                assert.equal(data.models.Test.properties.test.type, 'string');
                                assert.equal(data.models.Test.properties.test.description, 'A property');
                                assert.equal(data.models.Test.properties.test2.type, 'array');
                                assert.equal(data.models.Test.properties.test2.description, 'Array of Test2s');
                                assert.equal(data.models.Test.properties.test2.items.$ref, 'Test2');
                                assert.equal(data.models.Test2.id, 'Test2');
                                assert.equal(data.models.Test2.description, 'Another test model');
                                assert.equal(data.models.Test2.required.length, 2);
                                assert.ok(_.contains(data.models.Test2.required, 'test'));
                                assert.ok(_.contains(data.models.Test2.required, 'num'));
                                assert.equal(data.models.Test2.properties.test.type, 'array');
                                assert.equal(data.models.Test2.properties.test.description, 'A property');
                                assert.equal(data.models.Test2.properties.test.items.type, 'string');
                                assert.equal(data.models.Test2.properties.num.type, 'number');
                                assert.equal(data.models.Test2.properties.num.description, '');

                                callback();
                            });
                        }
                    });
                });
            });
        });
    });
});
